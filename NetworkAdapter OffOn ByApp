#NoEnv  
#Persistent
#NoTrayIcon
#SingleInstance force
SetWorkingDir %A_ScriptDir% 
SetBatchLines, -1
SetWinDelay, -1
ListLines, off

IfnotExist, %A_ScriptDir%\NetAccess.acc
{
FileAppend, ahk_exe firefox.exe, %A_ScriptDir%\NetAccess.acc
FileAppend, `nahk_exe iexplore.exe, %A_ScriptDir%\NetAccess.acc
FileAppend, `nahk_exe chrome.exe, %A_ScriptDir%\NetAccess.acc
FileAppend, `nahk_exe opera.exe, %A_ScriptDir%\NetAccess.acc
}

for objItem in ComObjGet("winmgmts:\\.\root\CIMV2").ExecQuery("SELECT * FROM Win32_NetworkAdapter WHERE PhysicalAdapter  = True")
{
        if (objItem.PNPDeviceID != "ROOT\NET\0000" && objItem.PNPDeviceID != "ROOT\VMWARE\0000")
        {
            NicName := objItem.NetConnectionID[0]
        }
}
Loop, read, %A_ScriptDir%\NetAccess.acc
{
        Loop, parse, A_LoopReadLine, %A_Tab%
        {
            GroupAdd, NetAccess, %A_LoopField%
        }
}

RunWait, *Runas %comspec% /c netsh.exe interface set interface name=%NicName% admin=disable, , min
Gosub, EnableAdapter

EnableAdapter:
WinWaitActive, ahk_Group NetAccess
IfWinExist, ahk_Group NetAccess
{
        RunWait, *Runas %comspec% /c netsh.exe interface set interface name=%NicName% admin=enable, , min
        Gosub, DisableAdapter
}
return

DisableAdapter:
WinGet, Process_ID, PID, ahk_Group NetAccess
Process, WaitClose, %Process_ID%
IfWinNotExist, ahk_Group NetAccess
{
        RunWait,  *Runas %comspec% /c netsh.exe interface set interface name=%NicName% admin=disable, , min
        GoSub, EnableAdapter
}
return
